<layout metal:use-macro="api.layout">
<metal:title metal:fill-slot="title">
  &mdash; <span tal:replace="project.title"/>
  &mdash; #<span tal:replace="issue.ref"/>: <span tal:replace="issue.title"/>
</metal:title>
<metal:header metal:fill-slot="header">
  &mdash;
  <a tal:attributes="href api.urlOf(project.name)" tal:content="project.title"/>
</metal:header>

<metal:content metal:fill-slot="content"
               tal:define="can_see_private_time_info api.hasPermission(
                         u'See private time information', project)">

<div id="content">
  <h1>
    <a tal:condition="len(changes) > 1"
       tal:attributes="href '#%d' % changes[-1].id"
       class="scrollToLastComment"
       title="scroll to last comment...">&darr;</a>
    <a tal:attributes="href api.urlOf('%s/%d' % (project.name, issue.id))"
       class="permalink" title="issue permalink">#</a>
     #<span tal:replace="issue.ref"/> &mdash;
    <span tal:replace="issue.title"/>
  </h1>

  <div class="change">
    <div class="changeText changeIssueText"
         tal:content="structure changes[0].getRenderedText()"/>
  </div>

  <ol id="changes"
      tal:condition="len(changes) > 1">
    <li tal:repeat="change changes[1:]"
        class="change">
      <div class="statusMessage"
           tal:condition="repeat['change'].end and api.request.params.get('issue_updated')"
           style="margin-bottom: 1em;">
        <a name="issue_updated"></a>
        The issue has been updated, see below.
      </div>
      <tal:defines tal:define="details change.getDetails(
                   include_private_time_info=can_see_private_time_info)">
        <h2 class="changeHeader">
          <a tal:attributes="name change.id;
                        href api.urlOf('%s/%d#%d' % (project.name, issue.id, change.id))"
             title="comment permalink"
             class="permalink">#</a>
          Update by <span tal:replace="change.author"/>
          on <span tal:replace="change.date.strftime('%d %B %Y at %H:%M')"/>
        </h2>
        <div class="changeText"
             tal:define="t change.getRenderedText()"
             tal:condition="t"
             tal:content="structure t">
        </div>
        <ul class="changeDetails"
            tal:condition="details">
          <li tal:repeat="detail details">
            <span tal:replace="detail.label"/>:
            <tal:if tal:condition="not detail.attr.startswith('time_spent_')">
              <span tal:replace="detail.before"/> &rarr;
            </tal:if>
            <span tal:replace="detail.after"/>
          </li>
        </ul>
      </tal:defines>
    </li>
  </ol>

  <form method="post"
        tal:condition="api.hasPermission(u'Participate in project', project)"
        tal:attributes="action api.urlOf(
                            '%s/%s/update' % (project.name, issue.ref))"
        tal:define="renderField api.form_macros['renderField'];
                    field_options {}">
    <fieldset>
      <legend>Comment or update issue</legend>
      <metal:issue-text-field metal:use-macro="api.form_macros['issue-text-field']"/>
      <metal:link-extra-fieldset metal:use-macro="api.form_macros['link-extra-fieldset']"/>
    </fieldset>

    <metal:issue-extra-fieldset
       metal:use-macro="api.form_macros['issue-extra-fieldset']"/>

    <div class="buttons">
      <button type="submit" class="positive">
        <img tal:attributes="src api.urlOf('static/img/tick.png')" alt=""/>
        Update
      </button>
    </div>
  </form>
</div>



<ul id="properties"
    tal:define="time_info issue.getTimeInfo(
                             include_private_info=can_see_private_time_info)">
  <li id="issueStatus" tal:content="issue.status"></li>
  <li>Kind: <span tal:replace="issue.getKind()"/></li>
  <li>Reported by <span tal:replace="issue.reporter"/></li>
  <li>
    Reported on
    <abbr tal:content="issue.date_created.strftime('%d %b %Y')"
          tal:attributes="title issue.date_created.strftime('%H:%M')"/>
  </li>
  <li tal:condition="issue.date_edited != issue.date_created">
    Updated on
    <abbr tal:content="issue.date_edited.strftime('%d %b %Y')"
          tal:attributes="title issue.date_edited.strftime('%H:%M')"/>
  </li>
  <li tal:condition="issue.assignee">
    Assigned to <span tal:replace="issue.assignee"/>
  </li>
  <li tal:condition="not issue.assignee"
      id="issueUnassigned">
    Unassigned
  </li>
  <li>Priority: <span tal:replace="issue.getPriority()"/></li>
  <li>Deadline: <span tal:replace="issue.deadline and issue.deadline.strftime('%d %b %Y') or 'none'"/></li>
  <li>Parent issue: FIXME</li>
  <li>Child issue(s): FIXME</li>
  <li tal:condition="can_see_private_time_info">
    Time estimated: <span tal:replace="time_info['estimated'] or 'none'"/>
  </li>
  <li>Time billed: <span tal:replace="time_info['billed'] or 'none'"/></li>
  <li tal:condition="can_see_private_time_info">
    Time spent (real): <span tal:replace="time_info['spent_real'] or 'none'"/>
  </li>
  <li>
    <tal:if tal:condition="not can_see_private_time_info">Time spent</tal:if>
    <tal:if tal:condition="can_see_private_time_info">Time spent (public)</tal:if>
    <span tal:replace="time_info['spent_public'] or 'none'"/>
  </li>
</ul>

</metal:content>
</layout>
